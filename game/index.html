<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Jeu de Memory</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="memory-wrapper mx-auto">
    <!-- Titre -->
    <div class="text-center mb-3">
      <h2 class="game-title">Memory Educentre</h2>
    </div>

    <!-- Score + Coups + bouton -->
    <div class="d-flex justify-content-center align-items-center gap-2">
      <div class="card info-card text-center">
        <div class="info-label">Score</div>
        <div class="info-value" id="score">0</div>
      </div>
      <div class="card info-card text-center">
        <div class="info-label">Coups</div>
        <div class="info-value" id="moves">0</div>
      </div>
    </div>

    <div class="text-center mt-3">
      <button id="replayButton" class="btn btn-outline-primary btn-new-game" style="display: none;">
        Rejouer
      </button>
    </div>

    <div class="memory-grid mt-4"></div>
  </div>
  <div id="winScreen" class="win-screen" style="display: none;">
    <div class="win-box">
      <h2 class="win-title">Bravo ! ðŸŽ‰</h2>
      <p class="win-text">Tu as trouvÃ© toutes les paires !</p>
      <p class="win-stats">
        Score : <span id="finalScore"></span><br>
        Coups : <span id="finalMoves"></span>
      </p>
      <button id="winReplayButton" class="btn btn-primary mt-3">Rejouer</button>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // DOM elements
  const grid = document.querySelector(".memory-grid");
  const backImageUrl =
    "https://cdn.leonardo.ai/users/fe0eef91-674f-4adb-aa53-0b1c831c4fe8/generations/f1024fa8-645a-44c4-a300-7af2205d5c89/segments/4:4:1/Lucid_Origin_I_need_a_simple_image_for_the_back_of_my_cards_16_3.jpg";

  const scoreElement = document.getElementById("score");
  const movesElement = document.getElementById("moves");
  const replayButton = document.getElementById("replayButton");

  // Win screen elements
  const winScreen = document.getElementById("winScreen");
  const finalScore = document.getElementById("finalScore");
  const finalMoves = document.getElementById("finalMoves");
  const winReplayButton = document.getElementById("winReplayButton");

  // Game state
  let gameImages = [];
  let firstCard = null;
  let secondCard = null;
  let lockBoard = false;
  let moves = 0;
  let score = 0;
  let matchedPairs = 0;
  let totalPairs = 0;

  function updateText() {
    scoreElement.textContent = score;
    movesElement.textContent = moves;
  }

  function randomPlaceImg(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function resetBoardSelection() {
    firstCard = null;
    secondCard = null;
    lockBoard = false;
    grid.classList.remove("locked");
  }

  // ðŸ”¥ Envoi des rÃ©sultats vers Educentre (si disponible)
  function sendResultToEducente(result) {
    // 1) Callback direct (le plus propre)
    if (typeof window.onMemoryGameEnd === "function") {
      window.onMemoryGameEnd(result);
    }

    // 2) Mode inter-iframe (si le jeu est embarquÃ©)
    window.parent.postMessage(
      { type: "memoryResult", payload: result },
      "*"
    );
  }

  function checkWin() {
    if (matchedPairs === totalPairs) {
      setTimeout(() => {
        const result = {
          score,
          moves,
          matchedPairs,
          totalPairs,
          timestamp: Date.now()
        };

        // Mettre Ã  jour lâ€™Ã©cran de victoire
        finalScore.textContent = score;
        finalMoves.textContent = moves;
        winScreen.style.display = "flex";

        // ðŸ”¥ Envoi des rÃ©sultats API Educentre (optionnel + sÃ»r)
        sendResultToEducente(result);

      }, 300);
    }
  }

  function handleCardClick(e) {
    const card = e.currentTarget;
    if (lockBoard) return;
    if (card.classList.contains("is-flipped")) return;

    card.classList.add("is-flipped");

    if (!firstCard) {
      firstCard = card;
      return;
    }

    secondCard = card;
    lockBoard = true;
    grid.classList.add("locked");
    moves++;
    updateText();

    const firstId = firstCard.dataset.id;
    const secondId = secondCard.dataset.id;

    if (firstId === secondId) {
      score += 10;
      matchedPairs++;

      firstCard.removeEventListener("click", handleCardClick);
      secondCard.removeEventListener("click", handleCardClick);

      updateText();
      resetBoardSelection();
      checkWin();
    } else {
      setTimeout(() => {
        firstCard.classList.remove("is-flipped");
        secondCard.classList.remove("is-flipped");
        resetBoardSelection();
      }, 800);
    }
  }

  // ðŸ”¥ Fonction exposÃ©e pour Educentre
  window.startMemoryGame = function(images) {
    gameImages = images;
    buildGame(images);
  };

  function buildGame(images) {
    replayButton.style.display = "none";
    grid.innerHTML = "";
    firstCard = null;
    secondCard = null;
    lockBoard = false;
    moves = 0;
    score = 0;
    matchedPairs = 0;
    totalPairs = images.length;
    updateText();

    const allCards = [];
    images.forEach((item) => {
      allCards.push({ ...item });
      allCards.push({ ...item });
    });

    randomPlaceImg(allCards);

    allCards.forEach((cardData) => {
      const card = document.createElement("div");
      card.className = "memory-card";
      card.dataset.id = cardData.id;

      const inner = document.createElement("div");
      inner.className = "memory-card-inner";

      const front = document.createElement("div");
      front.className = "memory-face memory-front";
      const frontImg = document.createElement("img");
      frontImg.src = backImageUrl;
      front.appendChild(frontImg);

      const back = document.createElement("div");
      back.className = "memory-face memory-back";
      const backImg = document.createElement("img");
      backImg.src = cardData.img;
      back.appendChild(backImg);

      inner.appendChild(front);
      inner.appendChild(back);
      card.appendChild(inner);

      card.addEventListener("click", handleCardClick);
      grid.appendChild(card);
    });
  }

  // ðŸ”¥ Mode standard (sans Educentre) â†’ charger img.json
  fetch("../img.json")
    .then((response) => response.json())
    .then((images) => {
      gameImages = images;
      buildGame(images);
    })
    .catch((error) => {
      console.error("Erreur JSON, fallback :", error);
    });

  // Replay Ã©cran basique
  replayButton.addEventListener("click", () => {
    buildGame(gameImages);
  });

  winReplayButton.addEventListener("click", () => {
    winScreen.style.display = "none";
    buildGame(gameImages);
  });
});
</script>

</body>
</html>